# App Builderã®ç´¹ä»‹

## App Builder

* GUI ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¤‡åˆã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼‰ã‚’ä½œæˆã§ãã‚‹ãƒ„ãƒ¼ãƒ«
* ã‚ã‚‰ã‹ã˜ã‚ç”¨æ„ã•ã‚ŒãŸå‡¦ç†ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§é–‹ç™ºã‚’é€²ã‚ã‚‹
  * ç”¨æ„ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã§å¯¾å¿œã§ããªã„å ´åˆã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚‚å¯èƒ½ãªãŸã‚æŸ”è»Ÿã«å®Ÿè£…å¯èƒ½

## App Builderæ¦‚è¦

![App Builderæ¦‚è¦](../../imgs/02_AppBuilder/slide3.png)

â‘  ã‚¿ã‚¹ã‚¯ã¨å‘¼ã°ã‚Œã‚‹ãƒœãƒƒã‚¯ã‚¹ã®ä¸€ã¤ä¸€ã¤ãŒå‡¦ç†ã®ã‹ãŸã¾ã‚Š  
_â‘¡_ å…¨ã¦ã®å‡¦ç†ã¯ã€ä¿å­˜ã™ã‚‹å‡¦ç†ã‚’å…¥ã‚Œãªã„é™ã‚Š DB ã‚’çµŒç”±ã›ãšã€ãƒ¡ãƒ¢ãƒªä¸Šã§è¡Œã‚ã‚Œã¾ã™  
_â‘¢_ ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›ã¯ã€æ¬¡ã®ã‚¿ã‚¹ã‚¯ã®å…¥åŠ›ã«ãªã‚Šã¾ã™  
â‘£ ãƒœãƒƒã‚¯ã‚¹é–“ã‚’ã¤ãªãçŸ¢å°ãŒã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¡¨ã™   


## é–‹ç™ºã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ä¸»è¦ãª Activity Pattern  

![App_Activity Pattern](../../imgs/02_AppBuilder/slide4.png)
1. ***Enrich***
    * ã‚¤ãƒ™ãƒ³ãƒˆã«å¯¾ã—ã¦ Type ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹å‡¦ç†
      * **ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã«æ°¸ç¶šåŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹**
2. ***Join***
    * ã‚¤ãƒ™ãƒ³ãƒˆã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’çµåˆã™ã‚‹å‡¦ç†
      * **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ã‚ãªã„çµåˆãŒã§ãã‚‹**
3. ***Transformation***
    * ã‚¤ãƒ™ãƒ³ãƒˆã‚’åŠ å·¥ã™ã‚‹å‡¦ç†
      * **ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å‰Šé™¤ãƒ»è¿½åŠ ã€å€¤ã®å¤‰æ›´ãªã©ã‚’è¡Œã†**
4. ***Dwell***
    * æ¡ä»¶ã‚’ä¸€å®šæœŸé–“æº€ãŸã™ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹å‡¦ç†
      * **ä»Šå›ã¯ 20ç§’é–“ç•°å¸¸å€¤ã«ãªã‚‹ã‹ã®åˆ¤å®šã§ä½¿ã†**


# ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

## Application ã®ãƒ‡ãƒãƒƒã‚°â‘ &nbsp;&nbsp; å‡¦ç†ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
* ã€Œã‚¿ã‚¹ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¡¨ç¤ºã€ã‚’ä½¿ç”¨ã—ã¦å‡¦ç†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã™ã‚‹
![ã‚¿ã‚¹ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¡¨ç¤ºã§ç¢ºèª](../../imgs/02_AppBuilder/slide6.png)

* ã‚¿ã‚¹ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œã‚¿ã‚¹ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¡¨ç¤ºã€ã‚’ä½¿ç”¨ã™ã‚‹

![ã‚¿ã‚¹ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¡¨ç¤ºã®ä½¿ç”¨](../../imgs/02_AppBuilder/slide7.png)

## Application ã®ãƒ‡ãƒãƒƒã‚°â‘¡&nbsp;&nbsp; ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª

* ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ç¢ºèªã—ã¦åŸå› ã‚’èª¿æŸ»ã™ã‚‹

![ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã®ç¢ºèª](../../imgs/02_AppBuilder/slide8.png)

_ï¼Š ãƒ‡ãƒãƒƒã‚° > ã‚¨ãƒ©ãƒ¼ > ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œ ã‹ã‚‰ã§ã‚‚ã‚¨ãƒ©ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤ºã§ãã¾ã™_

# Activity Pattern ç´¹ä»‹

## Contents

* Enrich\(Cached Enrich\)  
* Join  
* Transformation  
* SplitByGroup  
* Dwell  
* SaveToType  
* Statistics  
* Unwind  
* Smooth  
* Procedure  
* Filter  
* AccumulateState

## Enrichï¼ˆCached Enrichï¼‰

* ã‚¤ãƒ™ãƒ³ãƒˆã« Type ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹
* `Cached Enrich` ã¯ Type ã®å€¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãŠãã“ã¨ã«ã‚ˆã‚Šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ãŸ `Enrich` ã§ã™ã€‚ãã®ä»£ã‚ã‚Š Type ã®å€¤ã‚’å¤‰æ›´ã—ã¦ã‚‚ã€æ¬¡ã« Type ã®å€¤ã‚’å–å¾—ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¾ã§ã¯ã‚¤ãƒ™ãƒ³ãƒˆã«è¿½åŠ ã•ã‚Œã‚‹å€¤ã¨ã—ã¦åæ˜ ã•ã‚Œã¾ã›ã‚“
  * `Cached Enrich` ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯äº‹å‰ã« `SplitByGroup` ã‚’ä½¿ç”¨ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åˆ†å‰²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Enrich (Cashed Enrich) ä¾‹

![Cashed Enrich](../../imgs/02_AppBuilder/slide12.png)

â‘  å…¥åŠ›ã¨ãªã‚‹å‰ã®ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›  
```
{
ğŸ‘‰ "RPMSSensorID": "rpmsSensor3",
   "RPMS": 3222,
   "Time": "2020-03-19T04:42:24.021Z"
}
```

*Type ã¨ã‚¤ãƒ™ãƒ³ãƒˆãŒæŒã¤å…±é€šã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ (`RPMSSensorID`) ã‚’ Key ã¨ã—ã¦è¨­å®šã™ã‚‹*  

â‘¡ `Enrich` ã®å‡ºåŠ›  
```
{
   "RPMSSensorID": "rpmsSensor3",          #  â‘  "RPMSStream" ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›çµæœ
   "RPMS": 3222,                           #  â‘  "RPMSStream" ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›çµæœ
   "Time": "2020-03-19T04:42:24.021Z",     #  â‘  "RPMSStream" ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›çµæœ
   "Pumps": {                              # ã“ã‚Œä»¥é™ã¯ã‚¤ãƒ™ãƒ³ãƒˆã«è¿½åŠ ã•ã‚ŒãŸ Type ãŒæŒã¤ãƒ‡ãƒ¼ã‚¿
      "_id": "5e70949fc714e2125bbb8854",
      "Location": {
         "coordinates": [
            139.581,
            35.5442
         ],
         "type": "Point"
      },
      "PumpID": 3,
ğŸ‘‰    "RPMSSensorID": "rpmsSensor3",
      "TempSensorID": "tempSensor3",
      "ars_namespace": "Test",
      "ars_version": 1,
      "ars_createdAt": "2020-03-17T09:13:03.371Z",
      "ars_createdBy": "446b7d1d-2d7a-45f0-b74c-ba60866ced11"
   }
}
```

## Join  

* è¤‡æ•°ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆåŒå£«ã‚’çµåˆã™ã‚‹
* ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒç•°ãªã‚‹ã‚¤ãƒ™ãƒ³ãƒˆåŒå£«ã§ã‚‚çµåˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹
* å·¦å´ã«ä½ç½®ã™ã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒåŸºæº–ã¨ãªã‚‹

## Join ä¾‹

![Join](../../imgs/02_AppBuilder/slide14.png)


â‘  å…¥åŠ›ã¨ãªã‚‹å‰ã®ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›â‘   
```
{
  "TempSensorID": "tempSensor2",
  "Temp": 184,
  "Time": "2020-03-19T05:18:22.020Z",
  "Pumps": {
     "_id": "5e70949fc714e2125bbb8853",
     "Location": {
        "coordinates": [
           139.5819,
           35.5448
        ],
        "type": "Point"
     },
ğŸ‘‰       "PumpID": 2,
             - ç•¥ -
```
â‘¡ å…¥åŠ›ã¨ãªã‚‹å‰ã®ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›â‘¡  
```
{
  "RPMSSensorID": "rpmsSensor2",
  "RPMS": 3971,
  "Time": "2020-03-19T05:18:28.022Z",
  "Pumps": {
     "_id": "5e70949fc714e2125bbb8853",
     "Location": {
        "coordinates": [
           139.5819,
           35.5448
        ],
        "type": "Point"
     },
ğŸ‘‰       "PumpID": 2,
             - ç•¥ -
```  

*çµåˆã™ã‚‹ 2ã¤ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå…±é€šã—ã¦æŒã¤ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ (`PumpID`) ã‚’ Key ã¨ã™ã‚‹*  

â‘¢ `Join` ã®å‡ºåŠ›
```
{
   "EnrichTemp": {
      "TempSensorID": "tempSensor2",
      "Temp": 184,
      "Time": "2020-03-19T05:18:22.020Z",
      "Pumps": {
         "_id": "5e70949fc714e2125bbb8853",
         "Location": {
            "coordinates": [
               139.5819,
               35.5448
            ],
            "type": "Point"
         },
ğŸ‘‰       "PumpID": 2,
	               - ç•¥ -
      }
   },
   "EnrichRPMS": {
      "RPMSSensorID": "rpmsSensor2",
      "RPMS": 3971,
      "Time": "2020-03-19T05:18:28.022Z",
      "Pumps": {
         "_id": "5e70949fc714e2125bbb8853",
         "Location": {
            "coordinates": [
               139.5819,
               35.5448
            ],
            "type": "Point"
         },
ğŸ‘‰       "PumpID": 2,
	               - ç•¥ -
      }
   }
}
```

## Transformation

* ã‚¤ãƒ™ãƒ³ãƒˆã®å¤‰æ›ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹
* é …ç›®ã®è¿½åŠ ãƒ»å‰Šé™¤ã€`Procedure` ã®å‘¼ã³å‡ºã—ãªã©ã‚’ã—ã¦å¤‰æ›ã™ã‚‹

## Transformation ä¾‹

![Transformation](../../imgs/02_AppBuilder/slide16.png)

â‘  å…¥åŠ›ã¨ãªã‚‹å‰ã®ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›  
```
{
   "EnrichTemp": {
      "TempSensorID": "tempSensor2",
      "Temp": 184,
      "Time": "2020-03-19T05:18:22.020Z",
      "Pumps": {
         "_id": "5e70949fc714e2125bbb8853",
         "Location": {
            "coordinates": [
               139.5819,
               35.5448
            ],
            "type": "Point"
         },
         "PumpID": 2,
	               - ç•¥ -
      }
   },
   "EnrichRPMS": {
      "RPMSSensorID": "rpmsSensor2",
      "RPMS": 3971,
      "Time": "2020-03-19T05:18:28.022Z",
      "Pumps": {
         "_id": "5e70949fc714e2125bbb8853",
         "Location": {
            "coordinates": [
               139.5819,
               35.5448
            ],
            "type": "Point"
         },
         "PumpID": 2,
              	 - ç•¥ -
      }
   }
}
```
â‘¡ å¿…è¦ãªé …ç›®ã®ã¿ã«å¤‰æ›  
![configuration](../../imgs/02_AppBuilder/slide16_1.png) &nbsp; _ï¼Š_ Procedure å‘¼ã³å‡ºã—  

`Transformation` ã®å‡ºåŠ›  
```
{
ğŸ‘‰ "Location": {
      "coordinates": [
         139.581,
         35.5442
      ],
      "type": "Point"
   },
ğŸ‘‰ "PumpID": 3,
ğŸ‘‰ "RPMS": 3152,
ğŸ‘‰ "ReceivedAt": "2020-03-19T06:05:14.245Z",
ğŸ‘‰ "Temp": 194
}
```

## SplitByGroup

* ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åˆ†å‰²ã™ã‚‹
* `Dwell`ã€`Statistics` ãªã©ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã§ã¯ãªãç‰¹å®šã®ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«å‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®å‰ãªã©ã§ä½¿ç”¨ã™ã‚‹
* ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åˆ†å‰²ã™ã‚‹äº‹ã§ä½¿ç”¨ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãŒåˆ†æ•£ã™ã‚‹ãŸã‚è² è·åˆ†æ•£ã«ãªã‚‹

![SplitByGroup](../../imgs/02_AppBuilder/slide17.png)

## Dwell

* è¨­å®šã—ãŸæ¡ä»¶ã«åˆè‡´ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã€è¨­å®šã—ãŸæœŸé–“ç¶™ç¶šã—ã¦æ¤œå‡ºã—ãŸå ´åˆã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹

![Dwell](../../imgs/02_AppBuilder/slide18.png)  

â‘  æ¸©åº¦ãŒ 200åº¦ä»¥ä¸Šã€å›è»¢æ•°ãŒ 4000å›ä»¥ä¸ŠãŒ 20ç§’ç¶™ç¶šã—ãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œã¨è¨­å®š  
â‘¡ `Dwell` ã®å‡ºåŠ›
```
{
   "Location": {
      "coordinates": [
         139.5819,
         35.5448
      ],
      "type": "Point"
   },
   "PumpID": 2,
ğŸ‘‰ "RPMS": 4034,
   "ReceivedAt": "2020-03-19T11:59:33.227Z",
ğŸ‘‰ "Temp": 210
}
```

## SaveToType

* Type ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜ãƒ»æ›´æ–°ã™ã‚‹
* æ›´æ–°ã•ã›ã‚‹å ´åˆã¯ `Upsert` è¨­å®šã‚’è¡Œã†

## Statistics

* ã‚¿ã‚¹ã‚¯ã‚’é€šéã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã«å«ã¾ã‚Œã‚‹ 1ã¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®çµ±è¨ˆã‚’è¡Œã†
* ã‚«ã‚¦ãƒ³ãƒˆã€æœ€å°å€¤ã€æœ€å¤§å€¤ã€ä¸­å¤®å€¤ã€å¹³å‡å€¤ã€æ¨™æº–åå·®ã‚’å‡ºåŠ›ã™ã‚‹

![Statistics](../../imgs/02_AppBuilder/slide20.png)

â‘  å…¥åŠ›ã¨ãªã‚‹å‰ã®ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›  
```
{
   "RPMSSensorID": "rpmsSensor2",
   "Time": "2020-03-19T06:48:19.218Z",
   "RPMS": 3265,
   "PumpID": "pumpId2"
}
```
***ã“ã®ä¾‹ã§ã¯ PumpID ã”ã¨ã« RPMS ã®çµ±è¨ˆã‚’å–ã£ã¦ã„ã¾ã™ã€‚***  
***ï¼Š `Statistics` ã®å‰ã«ã¯ `SplitByGroup` ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚***  

â‘¡ `Statistics` ã®å‡ºåŠ›  
```
{
   "count": 34,                           # ã‚«ã‚¦ãƒ³ãƒˆ
   "mean": 3505.294117647059,             # å¹³å‡
   "min": 3042,                           # æœ€å°å€¤
   "max": 3997,                           # æœ€å¤§å€¤
   "median": 3463,                        # ä¸­å¤®å€¤
   "stdDeviation": 264.82567501314435,    # æ¨™æº–åå·®
   "ars_groupKey": "pumpId2"
}
```

## Unwind

* 1ã¤ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¤‡æ•°ã«åˆ†ã‘ã‚‹
* ã‚µã‚¤ã‚ºã®å¤§ãã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãã®ã¾ã¾å‡¦ç†ã™ã‚‹ã®ã§ã¯ãªãã€`Unwind` ã‚’ä½¿ã†äº‹ã§ã€åˆ†å‰²ã—ã¦ã‹ã‚‰å€‹ã€…ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸¦åˆ—å‡¦ç†ã™ã‚‹ã‚ˆã†ã«ãªã‚‹ãŸã‚è² è·åˆ†æ•£ã«ãªã‚‹

## Unwind ä¾‹

![Unwind](../../imgs/02_AppBuilder/slide22.png)

â‘  å…¥åŠ›ã¨ãªã‚‹å‰ã®ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›  
```
{
   "PumpID": 1,
   "Status": [
      {
â‘¡       "Temp": 190,
         "RPMS": 3560,
         "ts": "2020-01-01T00:00:01Z"
      },
      {
â‘¢       "Temp": 180,
         "RPMS": 4560,
         "ts": "2020-01-01T00:00:02Z"
      },
      {
â‘£       "Temp": 170,
         "RPMS": 5560,
         "ts": "2020-01-01T00:00:03Z"
      }
   ]
}
```
*1ã¤ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¤‡æ•°ã«åˆ†ã‘ã‚‹*  
â‘¡ `Unwind` ã®å‡ºåŠ›â‘   
```
{
   "PumpID": 1,
   "Temp": 170,
   "RPMS": 5560,
   "ts": "2020-01-01T00:00:03Z"
}
```
â‘¢ `Unwind` ã®å‡ºåŠ›â‘¡  
```
{
   "PumpID": 1,
   "Temp": 180,
   "RPMS": 4560,
   "ts": "2020-01-01T00:00:02Z"
}
```
â‘£ `Unwind` ã®å‡ºåŠ›â‘¢   
```
{
   "PumpID": 1,
   "Temp": 190,
   "RPMS": 3560,
   "ts": "2020-01-01T00:00:01Z"
}
```

## Smooth

* è¨­å®šã—ãŸæœŸé–“ã«é€šéã•ã›ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®æœ€å¤§æ•°ã‚’è¨­å®šã§ãã‚‹
* æ¬¡ä»¥é™ã®ã‚¿ã‚¹ã‚¯ãŒè¨±å®¹ã§ãã‚‹ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã«åˆã†ã‚ˆã†ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’èª¿æ•´ã§ãã‚‹

![Smooth](../../imgs/02_AppBuilder/slide23.png)

â‘  1åº¦ã« 10ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ  
â‘¡ 10ç§’ã§ 5ã‚¤ãƒ™ãƒ³ãƒˆã«è¨­å®š  
â‘¢ 10ç§’çµŒéæ™‚ç‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°  

## Procedure

* ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ Activity Pattern ã«ãªã„å‡¦ç†ã‚’ App Builder ã§ä½¿ç”¨ã—ãŸã„æ™‚ã«ä½¿ç”¨ã™ã‚‹
* è‡ªä½œã® Procedureï¼ˆVAILãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼‰ã‚’å‘¼ã³å‡ºã—ã¦ä½¿ã†ã“ã¨ãŒã§ãã‚‹

![Procedure](../../imgs/02_AppBuilder/slide24.png)

â‘  å…¥åŠ›ã¨ãªã‚‹å‰ã®ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›  
```
{
  "value": 1
}
```
â‘¡ å‘¼ã³å‡ºã—ã¦ã„ã‚‹è‡ªä½œ Procedure  
```
PROCEDURE myProcedure(event)
event.value += 1
return event
```
â‘¢ Procedure ã®å‡ºåŠ›  
```
{
  "value": 2
}
```

## Filter

* è¨­å®šã—ãŸæ¡ä»¶ã«åˆè‡´ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿é€šéã•ã›ã‚‹

![Filter](../../imgs/02_AppBuilder/slide25.png)

â‘  å…¥åŠ›ã¨ãªã‚‹å‰ã®ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›  
```
{
   "value": 200
}
```
â‘¡ è¨­å®šã—ãŸæ¡ä»¶  
```
event.value > 100
```
â‘¢ è¨­å®šã—ãŸæ¡ä»¶  
```
event.value == 100
```

## AccumulateState

* ã“ã® Activity Pattern ãŒè¨­å®šã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’é€šéã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½è·¡ã—ç¶šã‘ã‚‹
* `AccumulateState` ç”¨ã® Procedure ã‚’ä½œæˆã—ã¦è¨­å®šã™ã‚‹ãŸã‚ã€é€šéã—ã¦ã„ãã‚¤ãƒ™ãƒ³ãƒˆã«å¯¾ã—ã¦ä»»æ„ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹
  * `AccumulateState` ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯äº‹å‰ã« `SplitByGroup` ã‚’ä½¿ç”¨ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åˆ†å‰²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## AccumulateState ä¾‹: é€šéã—ãŸã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ã¿ã‚‹â¶

![AccumulateState_1](../../imgs/02_AppBuilder/slide27.png)

* `SampleAccumulateState` ã«ãŠã‘ã‚‹ ***1*** ä»¶ç›®ã®ã‚¤ãƒ™ãƒ³ãƒˆ
```
{
   "PumpID": 1,
   "Temp": 183,
   "RPMS": 3063,
   "Location": {
      "coordinates": [
         139.5811,
         35.5445
      ],
      "type": "Point"
   },
   "ReceivedAt": "2020-11-30T08:18:18.441Z",
   "current_status": {
ğŸ‘‰    "eventCount": 1
   }
}
```

* `SampleAccumulateState` ã«ãŠã‘ã‚‹ ***5*** ä»¶ç›®ã®ã‚¤ãƒ™ãƒ³ãƒˆ
```
{
   "PumpID": 4,
   "Temp": 183,
   "RPMS": 3896,
   "Location": {
      "coordinates": [
         139.5813,
         35.5447
      ],
      "type": "Point"
   },
   "ReceivedAt": "2020-11-30T08:18:18.464Z",
   "current_status": {
ğŸ‘‰    "eventCount": 5
   }
}
```



## AccumulateState ä¾‹: é€šéã—ãŸã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ã¿ã‚‹â·

**ä½œæˆã—ãŸ `AccumulateState` ç”¨ã® Procedure**  
```
PROCEDURESample.accumulateState(lastEventObject, event Object)
iflastEvent{     # ã“ã®ã‚¿ã‚¹ã‚¯ã‚’çµŒéã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆ
  lastEvent.eventCount++
} else {         # ã“ã®ã‚¿ã‚¹ã‚¯ã‚’çµŒéã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãŒã¾ã ãªã„å ´åˆ
  lastEvent = {
ğŸ‘‰  eventCount: 1
  }
}
return lastEvent
```  
&nbsp;&nbsp; ***ï¼Š ã‚¤ãƒ™ãƒ³ãƒˆãŒçµŒéã™ã‚‹ãŸã³ã«ã€ŒeventCountã€ãŒã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹***

## AccumulateState ä¾‹: é€šéã—ãŸã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ã¿ã‚‹â¸

![AccumulateState_3](../../imgs/02_AppBuilder/slide29.png)

â‘  _procedure_: `AccumulateState` ç”¨ã«è‡ªä½œã—ãŸ Procedure  
â‘¡ _outboundProperty_: `AccumulateState` ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å    

# é–¢é€£ãƒªã‚½ãƒ¼ã‚¹

- Vantiq Academy (è¦ãƒ­ã‚°ã‚¤ãƒ³)
  - [3.4: App Builder](https://community.vantiq.com/courses/vantiq%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e9%96%8b%e7%99%ba%e3%82%b3%e3%83%bc%e3%82%b9%ef%bc%86%e3%83%ac%e3%83%99%e3%83%ab1%e8%aa%8d%e5%ae%9a%e8%a9%a6%e9%a8%93v1-2/lessons/3-%e3%83%87%e3%83%bc%e3%82%bf%e3%81%ae%e6%a4%9c%e7%9f%a5%e3%81%a8%e9%96%a2%e9%80%a3%e3%81%a5%e3%81%91/topic/3-4-%e3%82%a2%e3%83%83%e3%83%97%e3%83%bb%e3%83%93%e3%83%ab%e3%83%80%e3%83%bc/)
  - [4.3: App Builderã®è¿½åŠ ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³](https://community.vantiq.com/courses/vantiq%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e9%96%8b%e7%99%ba%e3%82%b3%e3%83%bc%e3%82%b9%ef%bc%86%e3%83%ac%e3%83%99%e3%83%ab1%e8%aa%8d%e5%ae%9a%e8%a9%a6%e9%a8%93v1-2/lessons/4-%e3%83%87%e3%83%bc%e3%82%bf%e3%81%ae%e5%88%86%e6%9e%90%e3%81%a8%e3%82%a8%e3%83%b3%e3%83%aa%e3%83%83%e3%83%81/topic/4-3-app-builder%e3%81%ae%e8%bf%bd%e5%8a%a0%e3%81%ae%e3%82%a2%e3%82%af%e3%83%86%e3%82%a3%e3%83%93%e3%83%86%e3%82%a3%e3%83%91%e3%82%bf%e3%83%bc%e3%83%b3/)
  - [4.4: VAIL](https://community.vantiq.com/courses/vantiq%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e9%96%8b%e7%99%ba%e3%82%b3%e3%83%bc%e3%82%b9%ef%bc%86%e3%83%ac%e3%83%99%e3%83%ab1%e8%aa%8d%e5%ae%9a%e8%a9%a6%e9%a8%93v1-2/lessons/4-%e3%83%87%e3%83%bc%e3%82%bf%e3%81%ae%e5%88%86%e6%9e%90%e3%81%a8%e3%82%a8%e3%83%b3%e3%83%aa%e3%83%83%e3%83%81/topic/4-4-vail-2/)
  - [4.5: VAIL Procedure](https://community.vantiq.com/courses/vantiq%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e9%96%8b%e7%99%ba%e3%82%b3%e3%83%bc%e3%82%b9%ef%bc%86%e3%83%ac%e3%83%99%e3%83%ab1%e8%aa%8d%e5%ae%9a%e8%a9%a6%e9%a8%93v1-2/lessons/4-%e3%83%87%e3%83%bc%e3%82%bf%e3%81%ae%e5%88%86%e6%9e%90%e3%81%a8%e3%82%a8%e3%83%b3%e3%83%aa%e3%83%83%e3%83%81/topic/4-5-vail-procedure/)
  - [4.6: VAIL Rule](https://community.vantiq.com/courses/vantiq%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e9%96%8b%e7%99%ba%e3%82%b3%e3%83%bc%e3%82%b9%ef%bc%86%e3%83%ac%e3%83%99%e3%83%ab1%e8%aa%8d%e5%ae%9a%e8%a9%a6%e9%a8%93v1-2/lessons/4-%e3%83%87%e3%83%bc%e3%82%bf%e3%81%ae%e5%88%86%e6%9e%90%e3%81%a8%e3%82%a8%e3%83%b3%e3%83%aa%e3%83%83%e3%83%81/topic/4-6-vail-rule/)
