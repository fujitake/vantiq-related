# Vantiq クラスタの解体作業について
Vantiq クラスタ解体作業は、構築時の構成により作業内容が変わる。

## 構成確認チェックシート
インフラリソースが共有であるかどうかチェックを行う。共有されている場合、解体作業の中で当該リソースは削除できない。
- [ ] バックアップ用の S3/Azure Blob を他のシステムと共有していないか。
- [ ] Kubernetes クラスタを他のシステムと共有していないか。
- [ ] keycloak サーバーを他のシステムと共有していないか。
- [ ] Postgres サーバーを他のシステムと共有していないか。
- [ ] 作業用の踏み台マシンは他のシステムと共有していないか。
- [ ] 同一の kubernetes クラスタに複数の Vantiq インスタンスがデプロイされているか。（shared のリソースを共有しているか）
- [ ] VPC/VNET は共有されているか。
- [ ] 顧客の確認のサインをもらう

## バックアップ確認チェックシート
- [ ] mongodb/userdb バックアップファイルは退避されているか。もしくは不要であるか。
- [ ] keycloak サーバーのユーザー情報は退避されているか。もしくは不要であるか。
- [ ] namespace から必要なプロジェクトがエクスポートされ退避されているか。
- [ ] 顧客の確認のサインをもらう

## その他事前確認チェックシート
- [ ] Vantiq に依存するシステムからのシステム間連携は止められているか。
- [ ] Heartbeat の監視が終わっているか。
- [ ] チェックシートに基づく作業計画の作成、作業者の手配ができているか。
- [ ] 作業計画について承認を得ているか。

## 作業

作業には k8sdeploy_tools、kubectl、AWS/Azure CLI、Web コンソールを使用する。構築や保守に関わり各ツールを理解していることが作業者には求められる。権限を持つ者が作業を実行する。
万全を期すため、作業者以外に １人以上の立ち会いがいることが望ましい。

- `undeployVantiq` で Vantiq Pod の削除
- mongodb、userdb に紐づく PVC、PV の削除
- PV 削除により Release されたボリュームを AWS、Azure のコンソールから削除。
- mongodb backup ファイルの削除、もしくは退避
- S3/Azure Storage　Account の削除（共有でない場合）
- `undeployShared`、`undeployNigix` (同一クラスタに他の Vantiq インスタンスがない場合)
- keycloak サーバーのレルムを削除、必要であればエクスポートなどする
- keycloak サーバーの削除（keycloak サーバーが共有でない場合）
- Postgres サーバーの削除（Postgres サーバーが共有でない場合）
- Influx、MySQL に紐づく PVC、PV を削除
- PV 削除により Release されたボリュームを AWS、Azure のコンソールから削除
- Kubernetes のワーカー ノード プールを削除（共有でない場合）
- kubernetes のマスター コントロール プレーンを削除（共有でない場合）
- VPC/VNET に関わるリソースを削除（共有でない場合）

上記がすべて専有リソースの場合、構築時の terraform 定義で `terraform destroy` を行ってもよい。
解体時の作業を見越して、Azure ではリソースグループの適切な運用、AWS ではタグでグルーピングする適切な運用が期待される。

- DNS レコードの削除、または削除依頼
- 作業用の踏み台マシンを削除（共有でない場合）
- クラスタのステータスを更新
  - SalesForce アセットステータス
  - k8sdeploy_cluster(_jp)
