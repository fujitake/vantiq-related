# Vantiqクラスタの解体作業について
Vantiqクラスタ解体作業は、構築時の構成により作業内容が変わる。

## 構成確認チェックシート
インフラリソースが共有であるかどうかチェックを行う。共有されている場合、解体作業の中で当該リソースは削除できない。
- [ ] バックアップ用のS3/Azure Blobを他のシステムと共有していないか。
- [ ] Kubernetesクラスタを他のシステムと共有していないか。
- [ ] keycloakサーバーを他のシステムと共有していないか。
- [ ] Postgresサーバーを他のシステムと共有していないか。
- [ ] 作業用の踏み台マシンは他のシステムと共有していないか。
- [ ] 同一のkubernetesクラスタに複数のVantiqインスタンスがデプロイされているか。（sharedのリソースを共有しているか）
- [ ] VPC/VNETは共有されているか。
- [ ] 顧客の確認のサインをもらう

## バックアップ確認チェックシート
- [ ] mongodb/userdbバックアップファイルは退避されているか。もしくは不要であるか。
- [ ] keycloakサーバーのユーザー情報は退避されているか。もしくは不要であるか。
- [ ] namespaceから必要なプロジェクトがエクスポートされ退避されているか。
- [ ] 顧客の確認のサインをもらう

## その他事前確認チェックシート
- [ ] Vantiqに依存するシステムからのシステム間連携は止められているか。
- [ ] Heartbeatの監視が終わっているか。
- [ ] チェックシートに基づく作業計画の作成、作業者の手配ができているか。
- [ ] 作業計画について承認を得ているか。

## 作業

作業にはk8sdeploy_tools、kubectl, AWS/Azure CLI、Webコンソールを使用する。構築や保守に関わり各ツールを理解していることが作業者には求められる。権限を持つ者が作業を実行する。
万全を期すため、作業者以外に１人以上の立ち会いがいることが望ましい。

- `undeployVantiq`でVantiq Podの削除
- mongodb, userdbに紐づくPVC, PVの削除
- PV削除によりReleaseされたボリュームをAWS, Azureのコンソールから削除。
- mongodb backupファイルの削除、もしくは退避
- S3/Azure Storage　Accountの削除（共有でない場合）
- `undeployShared`, `undeployNigix` (同一クラスタに他のVantiqインスタンスがない場合)
- keycloakサーバーのレルムを削除、必要であればエクスポートなどする
- keycloakサーバーの削除（keycloakサーバーが共有でない場合）
- Postgresサーバーの削除（Postgresサーバーが共有でない場合）
- Influx, MySQLに紐づくPVC, PVを削除
- PV削除によりReleaseされたボリュームをAWS, Azureのコンソールから削除
- Kubernetesのワーカーノードプールを削除（共有でない場合）
- kubernetesのマスターコントールプレーンを削除（共有でない場合）
- VPC/VNETに関わるリソースを削除（共有でない場合）

上記がすべて専有リソースの場合、構築時のterraform定義で `terraform destroy` を行ってもよい。
解体時の作業を見越して、Azureではリソースグループの適切な運用、AWSではタグでグルーピングする適切な運用が期待される。

- DNSレコードの削除、または削除依頼
- 作業用の踏み台マシンを削除（共有でない場合）
- クラスタのステータスを更新
  - SalesForceアセットステータス
  - k8sdeploy_cluster(_jp)
